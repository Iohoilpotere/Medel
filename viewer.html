
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Viewer – Caso Clinico</title>
  <link rel="icon" href="./favicon.ico"/>
  <link rel="stylesheet" href="./css/base.css"/>
  <link rel="stylesheet" href="./css/stage.css"/>
  <link rel="stylesheet" href="./css/panels.css"/>
  <link rel="stylesheet" href="./css/viewer.css"/>
</head>
<body>
  <div class="viewer">
    <aside class="left">
      <div class="header">
        <div class="title">Step</div>
        <button id="collapseSteps" class="collapse" title="Comprimi/espandi">≪</button>
      </div>
      <div class="steps"></div>
    </aside>
    <main class="center">
      <div class="indicators" id="indicatorsBar"></div>
      <div class="canvasHost"><div id="viewerStage" class="stageWrap"></div></div>
      <div class="footer">
        <div class="buttons" style="display:flex; gap:10px; margin-left:auto;">
          <button id="btnConfirm" class="btn" style="display:none">Conferma</button>
          <button id="btnNext" class="btn">Avanti</button>
        </div>
      </div>
    
</main>
  </div>
  <script type="module" src="./viewer.js"></script>

<button id="btnImportJson" style="position:fixed;top:8px;right:12px;z-index:1000" class="btn btn-sm">Importa JSON</button>
<input id="fileImportJson" type="file" accept=".json,application/json" style="display:none" />
<script>
(function(){
  const btn = document.getElementById('btnImportJson');
  const file = document.getElementById('fileImportJson');
  if(btn && file){
    btn.addEventListener('click', ()=> file.click());
    file.addEventListener('change', async ()=>{
      const f = file.files && file.files[0]; if(!f) return;
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);
        if(window.Viewer && typeof window.Viewer.loadProject === 'function'){
          window.Viewer.loadProject(data);
        }else if(window.loadProject){ window.loadProject(data); }
        else { try{ sessionStorage.setItem('viewer_project', JSON.stringify(data)); location.reload(); }catch(e){ console.warn('API viewer loadProject non trovata e fallback fallito', e); } }
      }catch(err){ alert('JSON non valido: '+err.message); }
      file.value='';
    });
  }
})();
</script>

<!-- PATCH: toggle-all checkboxes and trigger change after load -->
<script>
(function(){
  function fire(el){
    try{ el.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
    try{ el.dispatchEvent(new Event('change', {bubbles:true})); }catch(e){}
  }
  function kick(root){
    if(!root) return;
    root.querySelectorAll('input[type=checkbox],input[type=radio]').forEach(fire);
  }
  window.addEventListener('load', function(){
    const stage = document.getElementById('viewerStage') || document;
    setTimeout(()=>kick(stage), 0);
    setTimeout(()=>kick(stage), 60);
    setTimeout(()=>kick(stage), 120);
  });

  // Add a small toggle-all button for debug (left of Confirm/Next)
  try{
    const footerBtns = document.querySelector('.footer .buttons');
    if(footerBtns){
      const toggler = document.createElement('button');
      toggler.id = 'btnToggleAllCheckboxes';
      toggler.className = 'btn';
      toggler.textContent = 'Toggle tutte le checkbox';
      toggler.addEventListener('click', ()=>{
        const root = document.getElementById('viewerStage') || document;
        const boxes = root.querySelectorAll('input[type=checkbox]');
        const anyUnchecked = Array.from(boxes).some(b=>!b.checked);
        boxes.forEach(b=>{ b.checked = anyUnchecked; fire(b); });
        try{ console.debug('[PATCH][toggle-all]', boxes.length, 'set to', anyUnchecked);}catch(e){}
      });
      footerBtns.insertBefore(toggler, footerBtns.firstChild);
    }
  }catch(e){}
})();
</script>

</body>
</html>